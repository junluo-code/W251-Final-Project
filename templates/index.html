{% extends "layout.html" %}

{% block content %}

    <div>


        <div class="row">
            <div class="col-md-8">
                <div id="mapid"></div>
            </div>
            <div class="col-md-4">

                <div id="eventDetail">
                    <table class="eventDetail">
                        <tr>
                            <td colspan="2" class="sectionHeader">Event</td>
                        </tr>
                        <tr>
                            <td class="leftCell">Name:</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="leftCell">Date & Time:</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td class="leftCell">URL:</td>
                            <td></td>
                        <tr>
                            <td class="leftCell">Attendance:</td>
                            <td></td>
                        </tr>
                        <tr><td colspan="2">&nbsp;</td></tr>
                        <tr><td colspan="2" class="sectionHeader">Venue</td></tr>
                        <tr><td colspan="2">fsdafafas</td></tr>
                        <tr><td colspan="2">&nbsp;</td></tr>
                        <tr><td colspan="2" class="sectionHeader">Topic(s)</td></tr>
                        <tr><td colspan="2"></td></tr>
                    </table>

                </div>


            </div>

        </div>


    </div>

    </div>

    <script>

        var rsvps = [];

        $.ajax({
            url: "/rsvp",
            dataType: "text",
            success: function (data) {
                rsvps = JSON.parse(data);
                //console.log(rsvps.length);
            }

        })
                .then(function () {
                    ShowVenues(rsvps);
                });


        function ShowVenues(rsvps) {
            var mymap = L.map('mapid').setView([39.8333333, -98.585522], 5);
            var markers = new Array();

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);

            for (var i = 0; i < rsvps.length; i++) {
                if (rsvps[i].venue != undefined) {
                    //console.log(rsvps[i].venue)
                    var v = rsvps[i].venue;
                    //console.log(v.lat + "...." + v.lon);
                    markers.push(new L.marker([v.lat, v.lon]));
                }
            }

            for (var j = 0; j < markers.length; j++) {
                mymap.addLayer(markers[j]);
            }
        }
        {#        var mymap = L.map('mapid').setView([39.8333333, -98.585522], 5);
                var markers = new Array();


                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                    id: 'mapbox.streets'
                }).addTo(mymap);


                var polling = setInterval(pollNewData, 3000);

                function pollNewData() {

                    for (i = 0; i < markers.length; i++) {
                        mymap.removeLayer(markers[i]);
                    }

                    $.get("/api/venue", function (data, status) {

                        var venues = $.parseJSON(JSON.stringify(data.results));
                        for (var i = 0; i < venues.length; i++) {

                            var venue = $.parseJSON(JSON.stringify(venues[i]));
                            //console.log(venue);
                            items = venue.split(",");
                            var lat, lon;
                            for (var j = 0; j < items.length; j++) {

                                var item = items[j];
                                if (item.indexOf("lat") >= 0) {
                                    lat = item.substring(7);
                                }
                                else if (item.indexOf("lon") >= 0) {
                                    lon = item.substring(7);

                                }

                            }

                            markers.push(new L.marker([lat, lon]));
                            mymap.addLayer(markers[i]);


                        }


                    });
                }#}


        {#


                L.marker([37.871332, -122.258508]).addTo(mymap)
                        .bindPopup("<b>Hello world!</b><br />MIDS rocks.").openPopup();

                L.circle([37.871332, -122.258508], 500, {
                    color: '#003262',
                    fillColor: '#FDB515',
                    fillOpacity: 0.5
                }).addTo(mymap).bindPopup("Go Bears.");


                var popup = L.popup();

                function onMapClick(e) {
                    popup
                            .setLatLng(e.latlng)
                            .setContent("You clicked the map at " + e.latlng.toString())
                            .openOn(mymap);
                }

                mymap.on('click', onMapClick);#}

    </script>

{% endblock %}